---
layout: post
title: 从0到1:构建出行领域的计费系统
category: arch
tags: 系统架构
keywords: 系统架构
description:
---

## 背景
目前曹操出行领域的三大主营业务: 专车、公务、帮忙。每个系统都有自己独立的计费逻辑。在业务初期，为了快速上线，每个业务都是由自己单独实现计费逻辑，并且都是和订单强耦合。

每个业务的规则制定以及计费逻辑有很大的相似性，这就无意中产生了大量重复的工作。在业务初期，为了业务迅速上线以及快速迭代，这种做法无疑是比较合适的，但是当系统稳定下来，随着业务逻辑的不断迭代，业务逐渐趋于复杂，剥离核心业务，在适当的时机建立能力(中台)系统是非常有必要性的。

独立业务边界清晰的能力系统，非常有利于新业务的快速试水。新业务只需要依赖相应的能力系统，就可以实现业务需求，快速上线，类似于搭积木。

## 重要性
计费系统统一每个业务线的计费规则，建立统一的计费规则配置后台。方便运营增加计费规则，以及维护计费规则。

统一账单模型，目前的账单还是简单的通过增加字段来进行扩展新的费用类型，这将会使账单表的字段越来越多。通过统一账单模型，对目前需要的和将来会需要的费用类型进行归纳以及合并。

在出行业务领域内，各种出行新业务层出不穷。但是都存在一些共性: 乘客下单之前需要预估费用，下单时需要记录计费规则，行程中需要时刻显示行程中费用，结束后需要记录总费用。所以剥离计费能力，独立计费系统，是相当具有远瞻性的。

在计费系统上线一个月之后，曹操的一个出行新业务目前正在快马加鞭的接入计费系统，新业务方完全没必要关心计费规则以及计费过程，彻底减少了新业务方的工作量。计费系统这边只需要简单的扩充计费规则，而不必更改整个计费的流程与架构。



## 挑战

- 统一计费规则。每个业务线既有共同的计费规则，也有差别巨大的计费规则，做到高度可配以及高度统一具有相当大的难度
- 统一账单模型。账单模型由费用决定，而费用又由计费规则决定，所以统一账单模型同样具有很大的难度
- 历史数据迁移。新的系统必定兼容以前的老数据，必须要做到大量历史数据完全正确映射到新的数据结构。
- 时间限制。在人力以及时间有限和不影响业务迭代的情况下实现最短的时间完成计费能力独立。

## 计费平台化

### 战略建模

#### 领域对象
计费系统一句话概括: 通过应用计价规则计算出账单。这里存在着两个很明显的领域对象:
![Alt text]({{ site.baseurl }}/assets/img/计费领域对象.jpeg)

接下来分析账单领域对象的生命周期，生命周期相当于一条总线，是账单从创建到结束的整个过程。
![Alt text]({{ site.baseurl }}/assets/img/账单生命周期.jpeg)
蓝色部分需要进行计费并产生相应的账单，即关联两个领域对象。其中预估、中间点产生的账单为一次性账单，只是给业务方展示，不进行存储。结束计费以及改价产生的账单需要进行存储。

红色部分并不进行计费，只是更新账单的状态以及核心属性。

那么，在进行计费时，又是通过什么去关联规则和账单呢？在这里，引入**计算器**的概念：计算器应用计价规则产生规则的明细账单，再由明细账单组成总账单。

所以计费系统的三个核心领域对象

- 规则
- 计算器
- 账单

#### 上下文
通过进行账单生命周期分析，得出四个关联规则、计算器、账单的计费上下文。
![Alt text]({{ site.baseurl }}/assets/img/new_context.png)
在这里，通过输入规则，经过上下文的规则转换、计算器处理、账单转换，最终输出符合格式的账单。很明显，四种上下文拥有共同的处理逻辑:

1. 规则转换器
  - 规则的种类是一定的，但是每种上下文使用的规则格式化也许相同，也许不同。这就需要每个上下文都必须有一个规则转换器容器。例如预估需要夜间里程规则，而中间点计费则不需要夜间里程规则。
2. 计算器
  - 计算器的种类由规则决定，每个上下文也需要对应的计算器容器。
3. 账单转换器
  - 明细账单也是由规则决定的，由计算器直接输出账单模型。最后明细账单需要转换成业务方需要的账单以及数据库中存储的账单结构。

### 数据流转

![]({{ site.baseurl }}/assets/img/do_convert.png)

数据流转如上图，业务方的数据传输对象(DTO)与数据库持久化对象(PO)分别通过转换器与领域对象(DO)进行数据交换，从而维持领域实体对象的独立性，并且使领域实体职责更加单一、明确，数据流转也更加清晰。

### 体系架构

![]({{ site.baseurl }}/assets/img/arch_new.png)

#### 业务方

目前只有公务出行接入了计费系统，其他业务线持续接入中。毫无疑问，虽然每个业务线的业务千差万别，但是计费逻辑必定都是在出行范畴内的，比如说里程、时长、折扣等等。凡是基于出行范畴内的计费逻辑都可以适配目前的计费系统。

#### 数据交换

- 业务方通过dubbo接口，传递计价规则的先决条件需要的参数，比如动态折扣需要的新人单数量
- 运营通过计费规则配置后台新增或者修改原始计费规则

#### 计费中台

通过对计费规则种类的分类以及归纳，把计费规则分成以下三大部分，并且每种规则都有与之相匹配的计算器与明细账单。这样以规则为出发点，辐射到计算器和账单。

- 计价规则

负责计算基础费用，每种计价规则属于相互独立，互不干扰。例如里程费、时长费、夜间费等等。
计算出每个规则的费用，并累计相加得到计价总费用。

- 定价规则

负责在计价总费用上进行再一次计算费用。多种定价规则必须按照顺序依次执行，当次定价规则的计算结果是下次定价规则的计算输入，首次的输入是计价总费用。例如企业折扣、最低消费。

- 精度规则

负责对定价结果进行精度计算。例如对四舍五入。

#### 依赖系统

- LBS系统负责提供行程计算

- 配置中心负责提供计费规则先决条件

### 未来规划

目前虽然实现了从0到1，但是还有从1到100这段很长的路要走。目前规划的由以下几点

- 动态调价

结合大数据实现计价单价的动态调整，定价规则的动态调整。

- 规则抽象

目前计费规则还不够高度抽象统一，比如可以合并成区间价格的规则方式。

- 账单模型

账单模型还需要进一步优化，需要抽象出KV格式的费用模型。
