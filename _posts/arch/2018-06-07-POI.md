---
layout: post
title: 基于UBER-H3的POI解决方案
category: arch
tags: poi
keywords: poi,lbs,h3,s2,geohash,es
description: 基于h3的POI解决方案
---
### 功能

- 落地POI数据
- 根据`(经纬度,半径,POI类型,自定义属性)`查询附近的POI

### 技术选型
- 原始方法

计算当前位置与所有POI的距离然后根据半径进行过滤，因为需要遍历所有的POI数据，所以效率很差

- 空间索引

对POI数据按照经纬度建立空间索引,计算出当前位置的空间索引和相邻索引。再根据索引去匹配查询POI数据。因为对全部的POI数据做了索引，所以查询效率会很快。

#### 空间索引算法选择
综上所述，肯定选择空间索引策略查询效率更高。经过调研，目前有三种空间索引算法。空间索引的原理简单点说就是将经纬度转换成唯一索引，每个索引代表一个多边形区域。


算法 | 索引类型| 多边形形状 |优缺点
---|--- |---|---
[H3](https://uber.github.io/h3/#/)| 64位数字 | 六边形|误差低/单个索引的相邻索引6个
S2| 64位数字 | 四边形 |误差低/单个索引的相邻索引8个
Geohash|字母数字组成的字符串|四边形|误差高/单个索引的相邻索引8个

以上简单列出了这三种算法的优缺点。因为我们要查找附近的POI数据，肯定相邻索引越少越好。最后选择Uber开源的H3空间索引算法。

#### 空间索引精度选择
在选择了H3算法后，我们需要确认H3的精度，即确认每个六边形的面积大小。这里有个H3精度的表格


H3 Resolution(精度) | 单个六边形大小(平方km) |六边形边长(km) | 全球六边形总数(索引总数)
---|--- | --- | ---
0	|4,250,546.8477000|	1,107.712591000|	122
1	|607,220.9782429|	418.676005500|	842
2	|86,745.8540347|	158.244655800|	5,882
3	|12,392.2648621|	59.810857940|	41,162
4	|1,770.3235517|	22.606379400|	288,122
5	|252.9033645|	8.544408276|	2,016,842
6	|36.1290521|	3.229482772|	14,117,882
7	|5.1612932|	1.220629759|	98,825,162
8	|0.7373276|	0.461354684|	691,776,122
9	|0.1053325|	0.174375668|	4,842,432,842
10	|0.0150475|	0.065907807|	33,897,029,882
11	|0.0021496|	0.024910561|	237,279,209,162
12	|0.0003071|	0.009415526|	1,660,954,464,122
13	|0.0000439|	0.003559893|	11,626,681,248,842
14	|0.0000063|	0.001348575|	81,386,768,741,882
15	|0.0000009|	0.000509713|	569,707,381,193,162

根据[H3的开发者建议](https://github.com/uber/h3/issues/71):
```
通常精度越小用处越小，resolution=0的六边形格子大小是大陆级别的。resolution从7开始才适合我们在日常生活中去应用。
resolution = 7  : 约城市级别的
resolution = 8  : 约小区级别的
resulution = 9  : 约街道级别的
resulution = 10 : 小于街道级别的
...
resulution = 15 : 约咖啡桌大小

在Uber内部没有真正使用过11-14精度，因为这些精度相对于车辆地图数据的粒度太细。
```
根据我们目前需要的POI数据类型(附近的POI)，我们选择resulution = 8 来描述我们的POI数据。

#### 如何使用H3
详细使用文档参考[官方文档](https://uber.github.io/h3/#/)，这里只介绍几个关键的容易混淆的API

### POI结构

列 |类型 | 描述
---|--- | ---
index |Long|H3标识(r=8)
type|Integer|poi类型
line|Integer|业务线
code|Integer|POI唯一标示
city|String|城市编号
location|String|经纬度
name|String|名称
address|String|地址
road|String|道路
attr1|自定义属性1|
attr2|自定义属性2|

- 存储的最小维度是POI
- 一个POI对应一个index
- 一个index对应多个POI

### es结构

```
/poi/poi/{h3格子唯一标示}_{经纬度}
{
  POI结构
}
```

### 系统架构
